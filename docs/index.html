import React, { useState, useEffect, useMemo } from 'react';
import { Search, Save, Plus, AlertCircle, Calculator, Info, RefreshCw, Lock, Shuffle } from 'lucide-react';

// --- Constants & Mock Data ---

const WEBSITES = ['Gamelobby', 'Sportsbook', 'LiveCasino_A', 'LiveCasino_B'];
const CURRENCIES = ['USD', 'CNY', 'HKD', 'JPY', 'TWD', 'SGD'];

// Mock server data: Currency Minimum Chip Defaults
const MIN_CHIP_DEFAULTS = {
  USD: 5,
  CNY: 20,
  HKD: 20,
  JPY: 500,
  TWD: 100,
  SGD: 10
};

// Minimum Limit Calculation Ratios
const MIN_RATIOS = {
  bp: 100, tie: 10, pair: 10, bonus: 10, bigSmall: 100, anyPair: 10, perfectPair: 10, superSix: 10,
};

// Maximum Limit Calculation Ratios
const MAX_RATIOS = {
  bp: 100, tie: 10, pair: 9, bonus: 9, bigSmall: 100, anyPair: 20, perfectPair: 4, superSix: 8,
};

// Mock Initial Data - IDs start from 10001 (5 digits)
const MOCK_DATA = [
  {
    id: '10001', website: 'LiveCasino_A', currency: 'USD', minChip: 5, status: 'Enable',
    limits: {
      bp: { min: 100, max: 10000 }, tie: { min: 10, max: 1000 }, pair: { min: 10, max: 900 },
      bonus: { min: 10, max: 900 }, bigSmall: { min: 100, max: 10000 }, anyPair: { min: 10, max: 2000 },
      perfectPair: { min: 10, max: 400 }, superSix: { min: 10, max: 800 },
    },
  },
  {
    id: '10002', website: 'LiveCasino_A', currency: 'CNY', minChip: 20, status: 'Disable',
    limits: {
      bp: { min: 500, max: 50000 }, tie: { min: 50, max: 5000 }, pair: { min: 50, max: 4500 },
      bonus: { min: 50, max: 4500 }, bigSmall: { min: 500, max: 50000 }, anyPair: { min: 50, max: 10000 },
      perfectPair: { min: 50, max: 2000 }, superSix: { min: 50, max: 4000 },
    },
  },
];

// --- Helper Functions ---

/** Converts a number to a localized string with commas. */
const formatNumber = (num) => {
  if (num === '' || num === undefined || num === null || isNaN(num)) return '';
  // Convert to number for proper formatting
  return Number(num).toLocaleString('en-US'); 
};

/** Parses a comma-separated string back to a pure number (or empty string). */
const parseNumber = (str) => {
  if (!str) return '';
  // 1. Remove commas and non-digit characters
  const cleanStr = str.toString().replace(/[^0-9]/g, ''); 
  if (cleanStr === '') return '';
  
  const parsed = Number(cleanStr);
  // Return the number or empty string
  return isNaN(parsed) ? '' : parsed; 
};

/** Extracts the numeric part of the ID and calculates the next sequential 5-digit ID. */
const getNextBetLimitId = (currentData) => {
  let maxIdNum = 10000; // Start at 10000 for 5 digits

  currentData.forEach(item => {
    // Attempt to parse the ID as a number
    const numPart = parseInt(item.id, 10); 
    
    // Check if it's a valid 5-digit ID or greater
    if (!isNaN(numPart) && numPart >= 10000 && numPart > maxIdNum) {
      maxIdNum = numPart;
    }
  });

  return (maxIdNum + 1).toString(); // Return as a string, e.g., "10003"
};


// --- Components ---

const LimitInputGroup = ({ title, minVal, maxVal, onMinChange, onMaxChange, isMain = false, minChipLimit, minRatio, maxRatio }) => {
  const min = parseNumber(minVal);
  const max = parseNumber(maxVal);
  
  // Validation logic
  const isMinError = min !== '' && min < minChipLimit;
  const isMaxError = max !== '' && min !== '' && max !== null && max < min;

  // 3. Ratio display format: Min: X% / Max: Y%
  return (
    <div className={`flex flex-col p-2 rounded h-full ${isMain ? 'bg-amber-50 border border-amber-200 shadow-sm' : 'bg-gray-50 border border-gray-200'}`}>
      <div className={`text-center mb-1 ${isMain ? 'text-amber-800 font-bold' : 'text-gray-500 font-medium'}`}>
         {/* Bet title on the first line, ratios on the second line */}
        <div className="text-sm">{title}</div>
        {/* Updated Ratio Display */}
        <div className="text-xs font-mono text-gray-400 flex justify-center gap-2">
            <span className="font-semibold">Min: {minRatio}%</span>
            <span className="font-semibold">Max: {maxRatio}%</span>
        </div>
      </div>
      
      {/* Min Limit Input */}
      <div className="mb-3">
        <div className="flex items-center gap-1 mb-1">
          <span className="text-[10px] text-gray-400 w-6 text-right font-medium">Min</span>
          <input
            type="text"
            value={formatNumber(minVal)}
            onChange={(e) => onMinChange(parseNumber(e.target.value))}
            className={`w-full text-right p-1 text-sm border rounded focus:ring-1 focus:outline-none transition-all
              ${isMain ? 'border-amber-300 focus:border-amber-500' : 'border-gray-300 focus:border-blue-500'}
              ${isMinError ? 'border-red-500 bg-red-50 focus:ring-red-200' : ''}
            `}
          />
        </div>
        {/* Error message placeholder to prevent layout shift (CLS) */}
        <div className="h-3.5">
          {isMinError && (
            <div className="text-[9px] text-red-600 leading-tight text-right pl-7 font-medium">
              Must be ≥ Min Chip
            </div>
          )}
        </div>
      </div>

      {/* Max Limit Input */}
      <div>
        <div className="flex items-center gap-1 mb-1">
          <span className="text-[10px] text-gray-400 w-6 text-right font-medium">Max</span>
          <input
            type="text"
            value={formatNumber(maxVal)}
            onChange={(e) => onMaxChange(parseNumber(e.target.value))}
            className={`w-full text-right p-1 text-sm border rounded focus:ring-1 focus:outline-none transition-all
              ${isMain ? 'border-amber-300 focus:border-amber-500' : 'border-gray-300 focus:border-blue-500'}
              ${isMaxError ? 'border-red-500 bg-red-50 focus:ring-red-200' : ''}
            `}
          />
        </div>
        {/* Error message placeholder to prevent layout shift (CLS) */}
        <div className="h-3.5">
          {isMaxError && (
            <div className="text-[9px] text-red-600 leading-tight text-right pl-7 font-medium">
              Must be ≥ Min Limit
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const App = () => {
  const [activeTab, setActiveTab] = useState('search'); // 'search' | 'create'
  const [data, setData] = useState(MOCK_DATA);
  const [notification, setNotification] = useState(null);

  // --- Create Form State ---
  const initialLimits = {
      bp: { min: '', max: '' }, tie: { min: '', max: '' }, pair: { min: '', max: '' },
      bonus: { min: '', max: '' }, bigSmall: { min: '', max: '' }, anyPair: { min: '', max: '' },
      perfectPair: { min: '', max: '' }, superSix: { min: '', max: '' },
  };

  const [newLimit, setNewLimit] = useState({
    id: '',
    website: '',
    currency: '', // Currency defaults to empty
    minChip: 0, // Initialized to 0, updated when currency is selected
    limits: initialLimits,
  });
  
  // Auto Calc inputs for Create Form
  const [baseMin, setBaseMin] = useState(''); // Base min limit (pure number input)
  const [baseMax, setBaseMax] = useState(''); // Base max limit (pure number input)

  // --- Search State ---
  const [searchFilters, setSearchFilters] = useState({
    id: '',
    website: '',
    currency: ''
  });
  const [searchResults, setSearchResults] = useState([]);
  const [hasSearched, setHasSearched] = useState(false);

  // --- Notification Helper ---
  const showNotification = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // --- Logic: Simulate Server Min Chip Fetch ---
  useEffect(() => {
    if (activeTab === 'create' && newLimit.currency) {
        // Only update minChip if a currency is selected
        const serverMinChip = MIN_CHIP_DEFAULTS[newLimit.currency] || 0;
        setNewLimit(prev => ({ ...prev, minChip: serverMinChip }));
    } else if (activeTab === 'create' && !newLimit.currency) {
        // When currency is empty, set minChip to 0 for validation purposes
        setNewLimit(prev => ({ ...prev, minChip: 0 }));
    }
  }, [newLimit.currency, activeTab]);

  // --- Logic: Generate ID ---
  const generateId = () => {
    const nextId = getNextBetLimitId(data);
    setNewLimit(prev => ({ ...prev, id: nextId }));
  };

  // --- Logic: Auto Calculation ---
  const handleBaseValueChange = (type, value) => {
    const numVal = parseNumber(value);
    
    // The value to use for calculation (use 0 if input is empty)
    const baseValue = numVal !== '' ? Number(numVal) : 0;
    
    // Select the correct ratio map
    const ratios = type === 'min' ? MIN_RATIOS : MAX_RATIOS;

    if (type === 'min') setBaseMin(numVal);
    else setBaseMax(numVal);

    // Auto-fill logic
    const updatedLimits = { ...newLimit.limits };
    Object.keys(ratios).forEach(key => {
      const ratio = ratios[key] / 100;
      const calculatedValue = Math.floor(baseValue * ratio);
      
      if (type === 'min') {
        // Use empty string if base input is empty, prevents showing 0
        updatedLimits[key].min = numVal === '' ? '' : calculatedValue;
      } else {
        updatedLimits[key].max = numVal === '' ? '' : calculatedValue;
      }
    });
    setNewLimit(prev => ({ ...prev, limits: updatedLimits }));
  };
  
  // --- Logic: Create ---
  const handleCreateSubmit = () => {
    // Basic validation
    if (!newLimit.website) return showNotification('Please select a Website.', 'error');
    if (!newLimit.currency) return showNotification('Please select a Currency.', 'error');
    
    // Use the Min Chip value from the defaults if currency is selected, otherwise use the temporary 0 value
    const currentMinChip = newLimit.currency ? MIN_CHIP_DEFAULTS[newLimit.currency] : 0;

    // Validate Min/Max logic and required B/P limits
    let hasError = false;
    let missingValue = false;
    
    Object.entries(newLimit.limits).forEach(([key, val]) => {
        const minValNum = parseNumber(val.min) === '' ? null : Number(parseNumber(val.min));
        const maxValNum = parseNumber(val.max) === '' ? null : Number(parseNumber(val.max));

        // Ensure Banker/Player limits are not empty
        if (key === 'bp' && (minValNum === null || maxValNum === null)) {
            missingValue = true;
        }

        // Check if Min ≥ Min Chip (using the dynamically fetched value)
        if (minValNum !== null && minValNum < currentMinChip) hasError = true;

        // Check if Max ≥ Min
        if (minValNum !== null && maxValNum !== null && maxValNum < minValNum) hasError = true;
    });

    if (missingValue) return showNotification('Banker/Player limits cannot be empty.', 'error');
    if (hasError) return showNotification('Please correct the errors in the limit fields (Min must be ≥ Min Chip, Max must be ≥ Min).', 'error');
    
    const finalId = newLimit.id || getNextBetLimitId(data);

    // Prepare payload for saving
    const payload = {
      ...newLimit,
      id: finalId,
      status: 'Enable',
      // Ensure the minChip saved is the correct one based on currency
      minChip: currentMinChip, 
    };

    // Convert limits to numbers (or empty string if empty)
    const limitsToSave = JSON.parse(JSON.stringify(newLimit.limits));
    Object.keys(limitsToSave).forEach(key => {
        limitsToSave[key].min = parseNumber(limitsToSave[key].min) !== '' ? Number(parseNumber(limitsToSave[key].min)) : '';
        limitsToSave[key].max = parseNumber(limitsToSave[key].max) !== '' ? Number(parseNumber(limitsToSave[key].max)) : '';
    });
    payload.limits = limitsToSave;

    setData(prev => [...prev, payload]);
    showNotification(`Bet Limit ${finalId} created successfully!`);
    
    // Reset form
    setNewLimit({
      id: '', website: '', currency: '', minChip: 0, limits: initialLimits,
    });
    setBaseMin('');
    setBaseMax('');
    setActiveTab('search');
  };

  // --- Logic: Search ---
  const handleSearch = () => {
    if (!searchFilters.id && !searchFilters.website) {
      showNotification('Website is required for search unless an ID is entered.', 'error');
      return;
    }

    let results = data;

    if (searchFilters.id) {
      results = results.filter(item => item.id.toLowerCase().includes(searchFilters.id.toLowerCase()));
    } else {
      results = results.filter(item => item.website === searchFilters.website);
      if (searchFilters.currency) {
        results = results.filter(item => item.currency === searchFilters.currency);
      }
    }

    results.sort((a, b) => a.id.localeCompare(b.id));

    // Format results: convert numbers back to strings for display in inputs
    const uiResults = results.map(item => ({
        ...item,
        limits: Object.fromEntries(
            Object.entries(item.limits).map(([key, limit]) => [
                key,
                { min: limit.min !== undefined && limit.min !== null ? limit.min : '', 
                  max: limit.max !== undefined && limit.max !== null ? limit.max : '' }
            ])
        )
    }));
    
    setSearchResults(JSON.parse(JSON.stringify(uiResults))); 
    setHasSearched(true);
  };

  // Logic: Modify inside Search Results
  const handleResultChange = (index, fieldPath, value) => {
    const newResults = [...searchResults];
    let current = newResults[index];
    for (let i = 0; i < fieldPath.length - 1; i++) {
      current = current[fieldPath[i]];
    }
    current[fieldPath[fieldPath.length - 1]] = value;
    setSearchResults(newResults);
  };

  // Logic: Save Modified Row
  const handleSaveRow = (index) => {
    const item = searchResults[index];
    
    let hasError = false;
    Object.entries(item.limits).forEach(([key, val]) => {
        const minValNum = parseNumber(val.min) === '' ? null : Number(parseNumber(val.min));
        const maxValNum = parseNumber(val.max) === '' ? null : Number(parseNumber(val.max));
        
        // Check if Min ≥ Min Chip
        if (minValNum !== null && minValNum < item.minChip) hasError = true;
        // Check if Max ≥ Min
        if (minValNum !== null && maxValNum !== null && maxValNum < minValNum) hasError = true;
    });

    if (hasError) return showNotification('Save Failed: Please check for errors in the highlighted red fields.', 'error');

    // Prepare payload for saving
    const savePayload = JSON.parse(JSON.stringify(item));
    Object.keys(savePayload.limits).forEach(key => {
        savePayload.limits[key].min = parseNumber(savePayload.limits[key].min) !== '' ? Number(parseNumber(savePayload.limits[key].min)) : '';
        savePayload.limits[key].max = parseNumber(savePayload.limits[key].max) !== '' ? Number(parseNumber(savePayload.limits[key].max)) : '';
    });

    const newData = data.map(d => d.id === savePayload.id ? savePayload : d);
    setData(newData);
    showNotification(`Bet Limit ${item.id} updated successfully!`);
  };

  return (
    // Use max-w-7xl wide container, suitable for admin UI
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans p-6">
      
      {/* Header */}
      <div className="max-w-7xl mx-auto mb-6">
        <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
           <Calculator className="w-8 h-8 text-blue-600" />
           Bet Limit Configuration (Baccarat)
        </h1>
        <p className="text-gray-500 text-sm mt-1">Configure bet limits based on Website and Currency.</p>
      </div>

      {/* Main Content Card */}
      <div className="max-w-7xl mx-auto bg-white rounded-lg shadow-xl border border-gray-200 overflow-hidden mb-6">
        
        {/* Tabs */}
        <div className="flex border-b border-gray-200">
          <button
            onClick={() => setActiveTab('search')}
            className={`flex-1 py-4 px-6 text-sm font-medium flex items-center justify-center gap-2 transition-colors ${activeTab === 'search' ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
          >
            <Search className="w-4 h-4" /> Search & Modify
          </button>
          <button
            onClick={() => setActiveTab('create')}
            className={`flex-1 py-4 px-6 text-sm font-medium flex items-center justify-center gap-2 transition-colors ${activeTab === 'create' ? 'bg-blue-50 text-blue-700 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
          >
            <Plus className="w-4 h-4" /> Create New Bet Limit
          </button>
        </div>

        <div className="p-6">
          {/* Notification */}
          {notification && (
            <div className={`mb-4 p-4 rounded-md flex items-center gap-2 ${notification.type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}`}>
              <AlertCircle className="w-5 h-5" />
              {notification.msg}
            </div>
          )}

          {/* === CREATE TAB === */}
          {activeTab === 'create' && (
            <div className="space-y-8">
              {/* Top Form: Basic Information (Desktop 4 columns) */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 items-start pb-6 border-b border-gray-100">
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Website <span className="text-red-500">*</span></label>
                  {/* Updated Styling for Website Dropdown Placeholder */}
                  <select 
                    className={`w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border ${newLimit.website === '' ? 'text-gray-400' : 'text-gray-800'}`}
                    value={newLimit.website}
                    onChange={(e) => setNewLimit({ ...newLimit, website: e.target.value })}
                  >
                    <option value="" disabled className="text-gray-400">Select Website</option>
                    {WEBSITES.map(w => <option key={w} value={w} className="text-gray-800">{w}</option>)}
                  </select>
                </div>
                
                <div className="col-span-1">
                  <label className="block text-sm font-medium text-gray-700 mb-1">Currency <span className="text-red-500">*</span></label>
                  <select 
                    className={`w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 border ${newLimit.currency === '' ? 'text-gray-400' : 'text-gray-800'}`}
                    value={newLimit.currency}
                    onChange={(e) => setNewLimit({ ...newLimit, currency: e.target.value })}
                  >
                    <option value="" disabled className="text-gray-400">Select Currency</option> 
                    {CURRENCIES.map(c => <option key={c} value={c} className="text-gray-800">{c}</option>)}
                  </select>
                </div>

                <div className="col-span-1 flex flex-col items-start gap-1">
                    <label className="mb-1 text-xs font-semibold text-gray-600 uppercase tracking-wider">Bet Limit ID (Optional)</label>
                    <div className="flex w-full gap-2">
                         <input
                            type="text"
                            value={newLimit.id}
                            onChange={(e) => setNewLimit({ ...newLimit, id: e.target.value })}
                            placeholder="Leave empty for auto-generate or press Generate"
                            className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-white focus:ring-blue-500 focus:border-blue-500 focus:outline-none focus:ring-2"
                        />
                         <button 
                            onClick={generateId}
                            className="px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors"
                            title="Generate Next ID"
                        >
                            <Shuffle className="w-4 h-4" /> Generate
                         </button>
                    </div>
                </div>

                <div className="bg-gray-100 p-3 rounded-md border border-gray-200 self-stretch">
                   <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1 flex items-center gap-1">
                     <Lock className="w-3 h-3" /> Currency MIN CHIP
                   </label>
                   <div className="flex items-center gap-2">
                     <span className="text-gray-400 text-xs">Value:</span>
                     <input 
                       type="text"
                       readOnly
                       className="w-full bg-transparent border-b border-gray-300 focus:outline-none text-sm font-medium text-gray-500 cursor-not-allowed font-semibold"
                       // Display 5 when no currency is selected (for demonstration)
                       value={newLimit.currency ? formatNumber(newLimit.minChip) : formatNumber(5)}
                     />
                   </div>
                   <p className="text-[10px] text-gray-400 mt-1">Min Limit must be ≥ this value.</p>
                </div>
              </div>

              {/* Quick Calc Section */}
              <div className="bg-blue-50 border border-blue-100 p-4 rounded-lg">
                <div className="flex items-center gap-2 mb-3">
                   <RefreshCw className="w-4 h-4 text-blue-600" />
                   <h3 className="text-sm font-bold text-blue-800">Quick Auto-Calculation</h3>
                </div>
                <div className="flex flex-col sm:flex-row gap-4 items-center">
                  <div className="w-full sm:w-48">
                    <label className="text-xs text-blue-600 font-semibold">Base Min Limit (100% Rate)</label>
                    <input 
                      type="text" 
                      className="w-full border border-blue-200 rounded p-2 text-right"
                      placeholder="e.g. 100"
                      value={baseMin} 
                      onChange={(e) => handleBaseValueChange('min', e.target.value)}
                    />
                  </div>
                  <div className="w-full sm:w-48">
                    <label className="text-xs text-blue-600 font-semibold">Base Max Limit (100% Rate)</label>
                    <input 
                      type="text" 
                      className="w-full border border-blue-200 rounded p-2 text-right"
                      placeholder="e.g. 10,000"
                      value={baseMax} 
                      onChange={(e) => handleBaseValueChange('max', e.target.value)}
                    />
                  </div>
                  <div className="text-xs text-blue-500 mt-5 sm:mt-0 flex-1">
                    Entering values here will automatically populate the fields below based on Min/Max Ratios.
                  </div>
                </div>
              </div>

              {/* Limits Matrix */}
              <div>
                <h3 className="text-sm font-bold text-gray-700 mb-3 border-l-4 border-amber-500 pl-2">Limit Configuration</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 items-stretch">
                  {/* Use LimitInputGroup component and pass all ratio and MinChip values */}
                  <LimitInputGroup 
                    title="Banker/Player" isMain={true} minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.bp} maxRatio={MAX_RATIOS.bp}
                    minVal={newLimit.limits.bp.min} maxVal={newLimit.limits.bp.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bp: { ...prev.limits.bp, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bp: { ...prev.limits.bp, max: v } } }))}
                  />
                  <LimitInputGroup title="Tie" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.tie} maxRatio={MAX_RATIOS.tie}
                    minVal={newLimit.limits.tie.min} maxVal={newLimit.limits.tie.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, tie: { ...prev.limits.tie, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, tie: { ...prev.limits.tie, max: v } } }))}
                  />
                  <LimitInputGroup title="Pair" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.pair} maxRatio={MAX_RATIOS.pair}
                    minVal={newLimit.limits.pair.min} maxVal={newLimit.limits.pair.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, pair: { ...prev.limits.pair, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, pair: { ...prev.limits.pair, max: v } } }))}
                  />
                   <LimitInputGroup title="Bonus" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.bonus} maxRatio={MAX_RATIOS.bonus}
                    minVal={newLimit.limits.bonus.min} maxVal={newLimit.limits.bonus.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bonus: { ...prev.limits.bonus, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bonus: { ...prev.limits.bonus, max: v } } }))}
                  />
                  <LimitInputGroup title="Big/Small" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.bigSmall} maxRatio={MAX_RATIOS.bigSmall}
                    minVal={newLimit.limits.bigSmall.min} maxVal={newLimit.limits.bigSmall.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bigSmall: { ...prev.limits.bigSmall, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, bigSmall: { ...prev.limits.bigSmall, max: v } } }))}
                  />
                  <LimitInputGroup title="Any Pair" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.anyPair} maxRatio={MAX_RATIOS.anyPair}
                    minVal={newLimit.limits.anyPair.min} maxVal={newLimit.limits.anyPair.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, anyPair: { ...prev.limits.anyPair, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, anyPair: { ...prev.limits.anyPair, max: v } } }))}
                  />
                  <LimitInputGroup title="Perfect Pair" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.perfectPair} maxRatio={MAX_RATIOS.perfectPair}
                    minVal={newLimit.limits.perfectPair.min} maxVal={newLimit.limits.perfectPair.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, perfectPair: { ...prev.limits.perfectPair, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, perfectPair: { ...prev.limits.perfectPair, max: v } } }))}
                  />
                  <LimitInputGroup title="Super Six" minChipLimit={newLimit.minChip}
                    minRatio={MIN_RATIOS.superSix} maxRatio={MAX_RATIOS.superSix}
                    minVal={newLimit.limits.superSix.min} maxVal={newLimit.limits.superSix.max}
                    onMinChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, superSix: { ...prev.limits.superSix, min: v } } }))}
                    onMaxChange={(v) => setNewLimit(prev => ({ ...prev, limits: { ...prev.limits, superSix: { ...prev.limits.superSix, max: v } } }))}
                  />
                </div>
              </div>

              {/* Action Button */}
              <div className="flex justify-end pt-4">
                <button 
                  onClick={handleCreateSubmit}
                  className="bg-blue-600 text-white px-6 py-2 rounded-md font-medium hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors flex items-center gap-2"
                >
                  <Save className="w-4 h-4" /> Save New Limit
                </button>
              </div>
            </div>
          )}

          {/* === SEARCH TAB === */}
          {activeTab === 'search' && (
            <div className="space-y-6">
              {/* Search Bar */}
              <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                 <div className="col-span-1">
                  <label className="block text-xs font-bold text-gray-500 mb-1">Website <span className="text-red-500">*</span></label>
                  <select 
                    className={`w-full text-sm border-gray-300 rounded-md shadow-sm p-2 border ${searchFilters.website === '' ? 'text-gray-400' : 'text-gray-800'}`}
                    value={searchFilters.website}
                    onChange={(e) => setSearchFilters(prev => ({...prev, website: e.target.value}))}
                  >
                    <option value="" disabled className="text-gray-400">Select Website...</option>
                    {WEBSITES.map(w => <option key={w} value={w} className="text-gray-800">{w}</option>)}
                  </select>
                </div>
                <div className="col-span-1">
                   <div className="flex flex-col w-full">
                        <label className="mb-1 text-xs font-semibold text-gray-600 uppercase tracking-wider">Bet Limit ID</label>
                        <input
                            type="text"
                            placeholder="e.g. 10001"
                            value={searchFilters.id}
                            onChange={(e) => setSearchFilters(prev => ({...prev, id: e.target.value}))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md text-sm bg-white focus:ring-blue-500 focus:border-blue-500 focus:outline-none focus:ring-2"
                        />
                    </div>
                </div>
                <div className="col-span-1">
                  <label className="block text-xs font-bold text-gray-500 mb-1">Currency (Optional)</label>
                  <select 
                    className={`w-full text-sm border-gray-300 rounded-md shadow-sm p-2 border ${searchFilters.currency === '' ? 'text-gray-400' : 'text-gray-800'}`}
                    value={searchFilters.currency}
                    onChange={(e) => setSearchFilters(prev => ({...prev, currency: e.target.value}))}
                  >
                    <option value="" disabled className="text-gray-400">Select Currency</option>
                    <option value="">All Currencies</option>
                    {CURRENCIES.map(c => <option key={c} value={c} className="text-gray-800">{c}</option>)}
                  </select>
                </div>
                <div className="col-span-1">
                  <button 
                    onClick={handleSearch}
                    className="w-full bg-gray-800 text-white px-4 py-2 rounded-md font-medium hover:bg-gray-900 transition-colors flex justify-center items-center gap-2"
                  >
                    <Search className="w-4 h-4" /> Search
                  </button>
                </div>
              </div>

              {/* Search Results Display */}
              {hasSearched && (
                <div className="mt-6">
                  <h3 className="text-sm font-bold text-gray-700 mb-4">Search Results ({searchResults.length})</h3>
                  
                  {searchResults.length === 0 ? (
                     <div className="text-center py-10 bg-white border border-dashed rounded text-gray-400">No results found.</div>
                  ) : (
                    <div className="space-y-6">
                      {searchResults.map((item, idx) => (
                        <div key={item.id} className="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                          {/* Row Header */}
                          <div className="bg-gray-50 px-4 py-2 border-b border-gray-200 flex flex-wrap gap-4 items-center justify-between">
                            <div className="flex items-center gap-4">
                              <span className="font-mono font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded text-sm">{item.id}</span>
                              <span className="text-sm font-semibold text-gray-700">{item.website} ({item.currency})</span>
                              <span className="text-sm text-gray-500 border-l pl-4 border-gray-300">
                                Min Chip: <span className="text-gray-500 font-semibold">{formatNumber(item.minChip)}</span> {/* Gray font */}
                              </span>
                            </div>
                            <div className="flex items-center gap-4">
                              <div className="flex items-center gap-2">
                                <span className="text-xs font-bold text-gray-500">Status:</span>
                                {/* Status toggle display */}
                                <span className={`px-2 py-0.5 text-xs font-medium rounded ${item.status === 'Enable' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {item.status}
                                </span>
                              </div>
                              <button 
                                onClick={() => handleSaveRow(idx)}
                                className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium hover:bg-blue-700 flex items-center gap-1"
                              >
                                <Save className="w-3 h-3" /> Save Changes
                              </button>
                            </div>
                          </div>

                          {/* Editable Grid */}
                          <div className="p-4 overflow-x-auto">
                            <div className="flex gap-2 min-w-max items-stretch">
                               {/* Use the same LimitInputGroup component for modification */}
                               <LimitInputGroup title="Banker/Player" isMain={true} minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.bp} maxRatio={MAX_RATIOS.bp}
                                  minVal={item.limits.bp.min} maxVal={item.limits.bp.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'bp', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'bp', 'max'], v)}
                                />
                                <LimitInputGroup title="Tie" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.tie} maxRatio={MAX_RATIOS.tie}
                                  minVal={item.limits.tie.min} maxVal={item.limits.tie.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'tie', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'tie', 'max'], v)}
                                />
                                <LimitInputGroup title="Pair" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.pair} maxRatio={MAX_RATIOS.pair}
                                  minVal={item.limits.pair.min} maxVal={item.limits.pair.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'pair', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'pair', 'max'], v)}
                                />
                                <LimitInputGroup title="Bonus" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.bonus} maxRatio={MAX_RATIOS.bonus}
                                  minVal={item.limits.bonus.min} maxVal={item.limits.bonus.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'bonus', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'bonus', 'max'], v)}
                                />
                                <LimitInputGroup title="Big/Small" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.bigSmall} maxRatio={MAX_RATIOS.bigSmall}
                                  minVal={item.limits.bigSmall.min} maxVal={item.limits.bigSmall.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'bigSmall', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'bigSmall', 'max'], v)}
                                />
                                <LimitInputGroup title="Any Pair" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.anyPair} maxRatio={MAX_RATIOS.anyPair}
                                  minVal={item.limits.anyPair.min} maxVal={item.limits.anyPair.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'anyPair', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'anyPair', 'max'], v)}
                                />
                                <LimitInputGroup title="Perfect Pair" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.perfectPair} maxRatio={MAX_RATIOS.perfectPair}
                                  minVal={item.limits.perfectPair.min} maxVal={item.limits.perfectPair.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'perfectPair', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'perfectPair', 'max'], v)}
                                />
                                <LimitInputGroup title="Super Six" minChipLimit={item.minChip}
                                  minRatio={MIN_RATIOS.superSix} maxRatio={MAX_RATIOS.superSix}
                                  minVal={item.limits.superSix.min} maxVal={item.limits.superSix.max}
                                  onMinChange={(v) => handleResultChange(idx, ['limits', 'superSix', 'min'], v)}
                                  onMaxChange={(v) => handleResultChange(idx, ['limits', 'superSix', 'max'], v)}
                                />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;
